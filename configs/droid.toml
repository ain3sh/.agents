# droid.toml - unified droid config file

# ------------------------------------------------------------------------------
[hooks]

# ---
[hooks.session_start]

[hooks.session_start.environment]
when = ["startup", "resume", "clear"]
secrets = "~/.factory/.env" # .env secrets loaded by env vars session-start hook
# config env vars
EXAMPLE_CONFIG_VAR = "clod"

[hooks.session_start.instructions]
prompts_dir = "~/.agents/prompts"
# prompt composition rules (ordered, files relative to prompts_dir)
[[hooks.session_start.instructions.rules]]
when = ["startup", "clear"]
include = ["instructions/OPERATOR.md"]
[[hooks.session_start.instructions.rules]]
when = ["compact"]
include = ["instructions/POST_COMPACT.md"]
[[hooks.session_start.instructions.rules]]
when = ["*"]
include = ["instructions/PRINCIPLES.md"]

# ---
[hooks.pre_tool_use]

[hooks.pre_tool_use.policy]
[hooks.pre_tool_use.policy.allow]
tools = ["LS", "Read", "WebFetch", "ExitSpecMode", "codebase:warpgrep_*","context:ask_docs_agent","context:fetch_docs","vscode:get_*","vscode:list_*"]
message = "[policy] {tool_name} is allowlisted"
[hooks.pre_tool_use.policy.ask]
tools = ["review:*"]
message = "[policy] confirm {tool_name} tool use"
[hooks.pre_tool_use.policy.deny]
tools = ["Grep","Skill","Task","codebase:edit_file"]
message = "[policy] {tool_name} is denylisted"
[hooks.pre_tool_use.policy.overrides."Grep"]
decision = "deny" # optional
message = "[policy] Grep blocked; use warpgrep for codebase searching, or read files directly for targeted info. If you must use regular grep, use it through bash." # optional

[hooks.pre_tool_use.commit_review_guard]
type = "committed"
max_chars = 6000

# ---
[hooks.post_tool_use]

[hooks.post_tool_use.instructions]
debug = false
prompts_dir = "~/.agents/prompts"

[[hooks.post_tool_use.instructions.rules]]
match.tool = "ExitSpecMode"
match.output = { approved = false }
include = ["instructions/IMPROVE_SPEC.md"]

[[hooks.post_tool_use.instructions.rules]]
match.tool = "ExitSpecMode"
match.output = { approved = true, isEdited = false }
include = ["instructions/IMPLEMENT_SPEC.md"]

[[hooks.post_tool_use.instructions.rules]]
match.tool = "ExitSpecMode"
match.output = { approved = true, isEdited = true }
include = ["instructions/IMPLEMENT_SPEC.md"]
include_text = ["Read ${filePath} fully to make a mental note of all changes made first."]

# ---
[hooks.notification]

# ---
[hooks.pre_compact]

# ---
[hooks.user_prompt_submit]

[hooks.user_prompt_submit.conflict_guard]
cache_dir = "/tmp/conflicts"
token_threshold = 20000
skip_prefix = "" # ignored if missing/null or empty string

# ---
[hooks.subagent_stop]

# ---
[hooks.stop]

# ---
[hooks.session_end]

[hooks.session_end.store_artifacts]
tail = 1
tail_when = ["prompt_input_exit", "other"]
todo_when = ["prompt_input_exit", "clear", "other"]

# ------------------------------------------------------------------------------